<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Un Futuro Ã¨ Possibile</title>
  <link rel="icon" href="favicon.ico?v=1" sizes="any">
  <link rel="icon" type="image/png" href="favicon-32x32.png?v=1" sizes="32x32">
  <link rel="icon" type="image/png" href="favicon-16x16.png?v=1" sizes="16x16">
  <link rel="apple-touch-icon" href="apple-touch-icon.png?v=1" sizes="180x180">
  <link rel="manifest" href="site.webmanifest">
  <meta name="theme-color" content="#8b00a3">

  <style>
    :root{
      --top-h: 140px;               /* altezza fascia top */
      --input-h: 100px;             /* altezza barra input */
      --input-visible: 1;           /* 1 visibile, 0 collassata (desktop) */
      --bg: #8b00a3;
      --fg: #ffffff;
      --muted: #f1d9f6;
      --col-gap: 28px;
      --fs: clamp(56px, 10vh, 160px);
      --row-gap: 14px;

      /* Barra input vars */
      --bar-pad-x: 16px;
      --bar-pad-y: 12px;
      --btn-w: 96px;     /* larghezza bottone desktop */
      --ctr-w: 64px;     /* larghezza area counter */
      --inner-gap: 10px; /* padding interno destro/sinistro dentro la textbox */
      --gap: 8px;        /* spazi interni vari */
    }

    /* SELF-HOSTED BEBAS NEUE */
    @font-face{ font-family: "BebasNeue"; src: url("./fonts/BebasNeue-Light.woff") format("woff");   font-weight: 300; font-style: normal; font-display: swap; }
    @font-face{ font-family: "BebasNeue"; src: url("./fonts/BebasNeue-Book.woff") format("woff");    font-weight: 400; font-style: normal; font-display: swap; }
    @font-face{ font-family: "BebasNeue"; src: url("./fonts/BebasNeue-Regular.woff") format("woff"); font-weight: 500; font-style: normal; font-display: swap; }
    @font-face{ font-family: "BebasNeue"; src: url("./fonts/BebasNeue-Bold.woff") format("woff");    font-weight: 700; font-style: normal; font-display: swap; }

    /* FONT TOP BAR (locale) */
    @font-face{
      font-family: "UahUnfontPossibile";
      src: url("./fonts/Uah_unfontpossibile-Regular.woff2") format("woff2"),
           url("./fonts/Uah_unfontpossibile-Regular.ttf") format("truetype");
      font-weight: 400; font-style: normal; font-display: swap;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    html, body { overflow-x: hidden; }     /* blocca scroll orizzontale globale */
    body{
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Helvetica, sans-serif;
      min-height: 100dvh;
      overflow: hidden; /* scroll solo nel banner (verticale) */
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    /* TOP BAR */
    .topBar {
      position: fixed;
      left: 0; right: 0; top: 0;
      height: calc(var(--top-h) + env(safe-area-inset-top, 0px));
      padding: calc(8px + env(safe-area-inset-top, 0px)) 16px 8px 16px;
      z-index: 30;
      background: var(--bg);
      color: #d7e046;
      display: flex; align-items: center; justify-content: center;
      text-align: center;
      font-family: "UahUnfontPossibile";
      font-size: 70px; line-height: 1; letter-spacing: .02em;
      max-width: 100vw;
    }

    /* Banner: altezza dipende dalla visibilitÃ  della input bar (desktop) */
    .banner{
      position: fixed;
      left: 0; right: 0;
      top: calc(var(--top-h) + env(safe-area-inset-top, 0px));
      height: calc(
        100dvh
        - var(--top-h)
        - (var(--input-h) * var(--input-visible))
        - env(safe-area-inset-bottom, 0px)
        - env(safe-area-inset-top, 0px)
      );
      z-index: 10;
      background: var(--bg);
      border: 0;
      display: grid;
      grid-template-rows: 1fr;
      transition: height .25s ease;
      max-width: 100vw;
    }

    /* SOLO Bebas nel banner */
    .banner, .banner *{
      font-family: "BebasNeue" !important;
      font-synthesis: none;
    }

    /* Colonne + scroll sull'inner (desktop) */
    .banner__inner{
      height: 100%;
      padding: 16px 16px;
      column-gap: var(--col-gap);
      column-fill: auto;
      column-count: 3; /* desktop */
      -webkit-column-count: 3; -moz-column-count: 3;

      overflow-y: auto; -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain; touch-action: pan-y;

      scrollbar-width: thin; scrollbar-color: rgba(255,255,255,.35) transparent;

      opacity: 1;                 /* visibile di default */
      transition: opacity .2s ease;
      max-width: 100vw;
    }
    .banner__inner::-webkit-scrollbar{ width: 10px; }
    .banner__inner::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.35); border-radius: 8px; }
    .banner__inner::-webkit-scrollbar-track{ background: transparent; }

    /* Ogni stringa = riga, centrata */
    .block{
      display: block; break-inside: avoid;
      margin: 0 0 var(--row-gap) 0; color: var(--fg);
      font-size: var(--fs); line-height: 1; letter-spacing: 0.01em;
      white-space: pre-wrap; word-break: break-word; overflow-wrap: anywhere;
      text-align: center; overflow: hidden; max-width: 100%;
    }

    /* Glifo speciale per "uah!" -> & con font UahUnfontPossibile */
    .uahGlyph{
      font-family: "UahUnfontPossibile" !important;
      font-weight: 400; font-size: 2em; line-height: 0.9;
      display: inline-block; vertical-align: -0.05em;
    }

    /* Dock input (contiene barra + handle) */
    .inputDock{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 20; pointer-events: none; max-width: 100vw;
    }

    /* Input bar */
    .inputBar{
      pointer-events: auto; position: absolute; left: 0; right: 0; bottom: 0;
      height: calc(var(--input-h) + env(safe-area-inset-bottom, 0px));
      background: var(--bg); border-top: 1px solid rgba(255,255,255,0.25);
      display: flex; align-items: center;
      padding: var(--bar-pad-y) var(--bar-pad-x) calc(var(--bar-pad-y) + env(safe-area-inset-bottom, 0px)) var(--bar-pad-x);
      color: var(--muted); transform: translateY(0%); transition: transform .25s ease; max-width: 100vw;
    }
    body.input-collapsed { --input-visible: 0; }
    body.input-collapsed .inputBar{ transform: translateY(100%); pointer-events: none; }

    .inputBar > form{ position: relative; flex: 1 1 auto; min-width: 0; width: 100%; pointer-events: auto; }
    .field{
      position: relative; width: 100%;
      border: 1px solid rgba(255,255,255,0.35); background: rgba(255,255,255,0.08);
      border-radius: 12px; padding: 0; min-height: 56px; display: block;
    }
    input[type="text"]{
      display: block; width: 100%; border: 0; outline: none; background: transparent; color: #fff;
      font-size: 18px; padding: 16px 18px; padding-right: calc(var(--btn-w) + var(--ctr-w) + (3 * var(--inner-gap)));
      border-radius: 12px;
    }
    .counter{
      position: absolute; right: calc(var(--btn-w) + (2 * var(--inner-gap)));
      top: 50%; transform: translateY(-50%); width: var(--ctr-w);
      text-align: right; color: var(--muted); font-size: 12px; white-space: nowrap; pointer-events: none;
    }
    .counter.warn{ color: #ffd966; }
    .inputBar button{
      position: absolute; right: var(--inner-gap); top: var(--inner-gap); bottom: var(--inner-gap);
      width: var(--btn-w); padding: 0 12px; border-radius: 10px; cursor: pointer;
      border: 1px solid rgba(255,255,255,0.8); background: transparent; color: #fff;
      font-weight: 800; font-size: 16px; white-space: nowrap;
    }
    .hint{ position: absolute; left: var(--bar-pad-x);
      bottom: calc(var(--bar-pad-y) + env(safe-area-inset-bottom, 0px));
      font-size: 12px; color: var(--muted); pointer-events: none;
    }

    .collapseToggle{
      pointer-events: auto; position: absolute; right: var(--bar-pad-x);
      bottom: calc(env(safe-area-inset-bottom, 0px) + (var(--input-h) * var(--input-visible)) + 12px);
      width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
      border-radius: 999px; border: 1px solid rgba(255,255,255,0.6);
      background: rgba(255,255,255,0.06); color: #fff; cursor: pointer;
      transition: transform .2s ease, background .2s ease, opacity .2s ease, bottom .25s ease; z-index: 25;
    }
    .collapseToggle:hover{ background: rgba(255,255,255,0.12); }
    .collapseToggle svg{ width: 18px; height: 18px; transition: transform .2s ease; }
    body.input-collapsed .collapseToggle svg{ transform: rotate(180deg); }

    .infoToggle{
      pointer-events: auto; position: absolute; left: var(--bar-pad-x);
      bottom: calc(env(safe-area-inset-bottom, 0px) + (var(--input-h) * var(--input-visible)) + 12px);
      width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
      border-radius: 999px; border: 1px solid rgba(255,255,255,0.6);
      background: rgba(255,255,255,0.06); color: #fff; font-weight: 800; font-size: 18px;
      text-decoration: none; cursor: pointer;
      transition: transform .2s ease, background .2s ease, opacity .2s ease, bottom .25s ease; z-index: 25;
    }
    .infoToggle:hover{ background: rgba(255,255,255,0.12); }
    .infoToggle:active{ transform: translateY(1px); }

    /* Mobile: compatta e forza layout VERTICALE */
    @media (max-width: 480px){
      :root{ --bar-pad-x: 12px; --bar-pad-y: 10px; --btn-w: 82px; --ctr-w: 52px; --inner-gap: 8px; --gap: 6px; }
      input[type="text"]{ padding: 12px 12px; font-size: 16px; }
      .inputBar button{ font-size: 15px; }
      .hint{ display: none; }
      .field{ min-height: 50px; }
    }

    @media (max-width: 600px){
      :root{ --col-gap: 18px; --row-gap: 10px; --fs: clamp(44px, 9.5vh, 120px); --top-h: 96px; }
      .banner__inner{
        column-count: initial !important; -webkit-column-count: initial !important; -moz-column-count: initial !important;
        display: flex !important; flex-direction: column; align-items: stretch; gap: var(--row-gap);
        overflow-x: hidden; touch-action: pan-y; opacity: 1 !important;
      }
      .block{ overflow-wrap: anywhere; word-break: normal; max-width: 100%; }
      .topBar{ font-size: 32px; }
      .collapseToggle{ display: none; }
      :root{ --input-visible: 1; }
    }
  </style>
</head>
<body>

  <!-- TOP BAR -->
  <div class="topBar">un futuro Ã¨ possibile quando...</div>

  <!-- BANNER -->
  <div class="banner" aria-hidden="true">
    <div class="banner__inner" id="bannerGrid">
      <!-- Fallback statico se JS non parte -->
      <div class="block">Scrivi qui sotto </div>
    </div>
  </div>

  <!-- INPUT DOCK -->
  <div class="inputDock">
    <div class="inputBar">
      <form id="wordForm" autocomplete="off">
        <div class="field">
          <input id="wordInput" type="text" maxlength="100" placeholder="Dicci la tua (max 100)" />
          <span class="counter"><span id="charCount">0</span>/100</span>
          <button type="submit">Invia</button>
        </div>
      </form>
      <div class="hint" id="hint"></div>
    </div>

    <!-- Freccia toggle (solo desktop via CSS) -->
    <button class="collapseToggle" id="collapseToggle" aria-expanded="true" aria-label="Nascondi barra">
      <!-- caret down -->
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path fill="currentColor" d="M7 10l5 5 5-5z"/>
      </svg>
    </button>

    <!-- Nuovo pulsante â€œ?â€ a sinistra, visibile anche su mobile -->
    <a class="infoToggle" id="infoToggle" href="about.html" aria-label="Vai alla pagina About" title="About">?</a>
  </div>

  <!-- Supabase SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // === SUPABASE CONFIG ===
    const SUPABASE_URL = 'https://jndommppkmwrrpmxhfzu.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuZG9tbXBwa213cnJwbXhoZnp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3Njg2MDAsImV4cCI6MjA3ODM0NDYwMH0.pwhNlDTgvRWWkmWaSesmN0iBlEzJ6BJEaFyE3NsKP2A';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === PARAMS ===
    const REFRESH_MS = 30000;
    const MAX_FETCH = 1200;
    const MAX_DISPLAY = 1200;
    const MAX_PER_SUBMIT = 5;
    const COOLDOWN_MS = 4000;
    const DB_MAX = 100;
    const MAX_INPUT = 100;

    // === BLOCKLIST REMOTA (Supabase Storage) ===
    const BLOCKLIST_URL = 'https://jndommppkmwrrpmxhfzu.supabase.co/storage/v1/object/public/config/blocklist.txt';
    const BLOCKLIST_REFRESH_MS = 10 * 60 * 1000; // 10 minuti
    let BLOCKLIST = [];

    function normalizeForMatch(s){
      const map = { '0':'o','1':'i','3':'e','4':'a','5':'s','7':'t','8':'b' };
      return s
        .toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/[0-9]/g, d => map[d] || d)
        .replace(/[^a-z\s]/g, '')
        .replace(/\s+/g, ' ')
        .trim()
        .replace(/(.)\1{2,}/g, '$1$1');
    }

    async function loadBlocklist(){
      try{
        const res = await fetch(BLOCKLIST_URL, { cache: 'no-store' });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const txt = await res.text();
        const items = txt.split(/\r?\n/).map(l => l.trim()).filter(l => l && !l.startsWith('#') && !l.startsWith('//'));
        BLOCKLIST = [...new Set(items.map(normalizeForMatch).filter(x => x.length >= 3))];
        localStorage.setItem('blocklist_cache', JSON.stringify({ ts: Date.now(), items: BLOCKLIST }));
      }catch(e){
        const c = localStorage.getItem('blocklist_cache');
        if (c){
          try { BLOCKLIST = JSON.parse(c).items || []; } catch {}
        }
      }
    }

    function isBlocked(text){
      const t = normalizeForMatch(text);
      return BLOCKLIST.some(b => t.includes(b)); // match semplice (substring normalizzato)
    }

    // === DOM ===
    const grid = document.getElementById('bannerGrid');
    const form = document.getElementById('wordForm');
    const input = document.getElementById('wordInput');
    const hint = document.getElementById('hint');
    const charCountEl = document.getElementById('charCount');
    const toggleBtn = document.getElementById('collapseToggle');

    // === DEVICE ID ===
    function getDeviceId(){
      try {
        let id = localStorage.getItem('device_id');
        if (!id) {
          id = crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2);
          localStorage.setItem('device_id', id);
        }
        return id;
      } catch {
        return Math.random().toString(36).slice(2);
      }
    }
    const DEVICE_ID = getDeviceId();

    // === UTILS ===
    let lastSubmitAt = 0;
    const escapeMap = { '<':'&lt;', '>':'&gt;', '&':'&amp;', '"':'&quot;' };
    const sanitize = s => s.replace(/[<>"&]/g, ch => escapeMap[ch]);
    const isLink = s => /(https?:\/\/|www\.)/i.test(s);

    const tokenize = raw => raw
      .split(/(?:,|\n)+/)
      .map(s => s)
      .filter(s => s.replace(/\s/g,'').length > 0);

    function ensureTrailingSpace(w){
      if (w.endsWith(' ')) return w.slice(0, DB_MAX);
      if (w.length < DB_MAX) return w + ' ';
      return w.slice(0, DB_MAX - 1) + ' ';
    }

    const WEIGHTS = [300, 400, 500, 700];
    function fnv1a(str){ let h=0x811c9dc5; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,0x01000193);} return h>>>0; }
    function pickWeightForItem(item){ const key = (item.id != null) ? String(item.id) : item.word; return WEIGHTS[fnv1a(key)%WEIGHTS.length]; }

    function renderWithUah(container, text){
      const re = /uah!/gi; let last = 0, m;
      while ((m = re.exec(text)) !== null) {
        if (m.index > last) container.append(document.createTextNode(text.slice(last, m.index)));
        const span = document.createElement('span'); span.className = 'uahGlyph'; span.textContent = '&'; container.append(span);
        last = m.index + m[0].length;
      }
      if (last < text.length) container.append(document.createTextNode(text.slice(last)));
    }

    let wordsCache = [];

    async function fetchWordsRemote(){
      try{
        const { data, error } = await sb
          .from('words')
          .select('id, word, created_at')
          .order('created_at', { ascending: false })
          .limit(MAX_FETCH);
        if (error) throw error;
        wordsCache = data || [];
      }catch(e){
        console.warn('Fetch error:', e.message || e);
      }finally{
        buildWall();  // costruisci comunque (placeholder se niente dati)
      }
    }

    async function insertWordsRemote(tokens){
      if (!tokens.length) return;
      let clean = tokens
        .map(t => sanitize(t))
        .filter(Boolean)
        .filter(w => !isLink(w))
        .filter(w => !isBlocked(w))
        .slice(0, MAX_PER_SUBMIT)
        .map(ensureTrailingSpace);

      if (!clean.length) {
        hint.textContent = 'Contenuto non consentito';
        setTimeout(()=>{ hint.textContent=''; },1500);
        return;
      }

      const now = Date.now();
      if (now - lastSubmitAt < COOLDOWN_MS) {
        hint.textContent = 'Aspetta un attimo ðŸ™‚';
        setTimeout(()=>{ hint.textContent=''; },1200);
        return;
      }
      lastSubmitAt = now;

      try{
        const { data, error } = await sb
          .from('words')
          .insert(clean.map(w => ({ word:w, device_id: DEVICE_ID })))
          .select('id, word, created_at');
        if (error) throw error;
        (data || []).forEach(r => wordsCache.unshift(r));
      }catch(e){
        console.error('Insert error:', e.message || e);
      }finally{
        buildWall();
        setTimeout(()=>{ hint.textContent=''; },1200);
      }
    }

    function makeBlock(item){
      const el = document.createElement('div'); el.className = 'block';
      el.style.fontWeight = pickWeightForItem(item);
      renderWithUah(el, item.word);
      return el;
    }

    function buildWall(){
      if (!grid) return;
      grid.innerHTML = '';
      const items = (wordsCache || []).filter(it => !isBlocked(it.word)).slice(0, MAX_DISPLAY);
      if (items.length === 0){
        grid.appendChild(makeBlock({ id: 0, word: 'Scrivi qui sotto ' }));
      } else {
        for (const it of items){ grid.appendChild(makeBlock(it)); }
      }
      grid.style.opacity = '1'; // forza visibile su tutti i device
    }

    function setCollapsed(on){
      document.body.classList.toggle('input-collapsed', !!on);
      const expanded = !on;
      toggleBtn.setAttribute('aria-expanded', String(expanded));
      toggleBtn.setAttribute('aria-label', expanded ? 'Nascondi barra' : 'Mostra barra');
    }
    toggleBtn.addEventListener('click', () => {
      const isCollapsed = document.body.classList.contains('input-collapsed');
      setCollapsed(!isCollapsed);
    });

    function handleResize(){ if (window.matchMedia('(max-width: 600px)').matches){ setCollapsed(false); } }
    window.addEventListener('resize', handleResize);

    document.addEventListener('DOMContentLoaded', async () => {
      input.focus();
      buildWall();            // placeholder immediato
      updateCounter();
      await loadBlocklist();  // carica blocklist (fallback cache se offline)
      setInterval(loadBlocklist, 10 * 60 * 1000);
      await fetchWordsRemote();
      setInterval(fetchWordsRemote, REFRESH_MS);
      handleResize();
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const raw = input.value;
      if (!raw) return;
      const tokens = tokenize(raw);
      input.value = '';
      updateCounter();
      await insertWordsRemote(tokens);
    });

    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) { loadBlocklist(); fetchWordsRemote(); }
    });

    function updateCounter(){
      const len = input.value.length;
      document.getElementById('charCount').textContent = len;
      document.querySelector('.counter').classList.toggle('warn', len >= 90);
    }
    input.addEventListener('input', updateCounter);
  </script>
</body>
</html>
